<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <!-- Fonts and Styles -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/styles/overlayscrollbars.min.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
   <link rel="stylesheet" href="/dist/css/adminlte.css">


  <style>
    /* Scrollable table for agents */
    .scrollable-table {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
       <nav class="app-header navbar navbar-expand bg-body">
           <div class="container-fluid">
             <!-- Sidebar Toggle -->
             <ul class="navbar-nav">
               <li class="nav-item">
                 <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                   <i class="bi bi-list"></i>
                 </a>
               </li>
               <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Home</a></li>
               <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Contact</a></li>
             </ul>
         
             <!-- Right Navbar Links -->
             <ul class="navbar-nav ms-auto">
               <!-- Search Icon -->
               <li class="nav-item"><a class="nav-link" data-widget="navbar-search" href="#"><i class="bi bi-search"></i></a></li>
               <!-- Messages Dropdown -->
               <li class="nav-item dropdown">
                 <a class="nav-link" data-bs-toggle="dropdown" href="#">
                   <i class="bi bi-chat-text"></i> <span class="navbar-badge badge text-bg-danger">3</span>
                 </a>
                 <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                   <!-- Message items here -->
                   <a href="#" class="dropdown-item">See All Messages</a>
                 </div>
               </li>
               <!-- Notifications Dropdown -->
               <li class="nav-item dropdown">
                 <a class="nav-link" data-bs-toggle="dropdown" href="#">
                   <i class="bi bi-bell-fill"></i> <span class="navbar-badge badge text-bg-warning">15</span>
                 </a>
                 <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                   <!-- Notification items here -->
                   <a href="#" class="dropdown-item">See All Notifications</a>
                 </div>
               </li>
               <!-- User Profile Dropdown -->
               <!-- <li class="nav-item dropdown">
                 <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">
                   <img src="/dist/assets/img/user2-160x160.jpg" class="user-image rounded-circle" alt="User Image"> <span class="d-none d-md-inline">Alexander Pierce</span>
                 </a>
                 <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                   <li class="user-header text-bg-primary">
                     <img src="/dist/assets/img/user2-160x160.jpg" class="rounded-circle" alt="User Image">
                     <p>Alexander Pierce - Web Developer</p>
                   </li>
                   <li class="user-footer">
                     <a href="#" class="btn btn-default btn-flat">Profile</a>
                     <a href="#" class="btn btn-default btn-flat float-end">Sign out</a>
                   </li>
                 </ul>
               </li> -->
             </ul>
           </div>
         </nav>
         
         <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
           <!-- Sidebar Brand -->
           <div class="sidebar-brand">
               <a href="/" class="brand-link">
                   <img src="/dist/assets/img/AdminLTELogo.png" alt="NAMA Logo" class="brand-image opacity-75 shadow">
                   <span class="brand-text fw-light">RMS</span>
               </a>
           </div>
         
            <!-- Sidebar Menu -->
     <div class="sidebar-wrapper">
       <nav class="mt-2">
           <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
               <!-- Dashboard -->
               <li class="nav-item">
                   <a href="/dashboard" class="nav-link active">
                       <i class="nav-icon bi bi-speedometer"></i>
                       <p>Dashboard</p>
                   </a>
               </li>
   
               <!-- Clients -->
               <li class="nav-item">
                   <a href="/client/getall" class="nav-link">
                       <i class="nav-icon bi bi-people"></i>
                       <p>Clients</p>
                   </a>
               </li>
   
               <!-- Grouped: Businesses, Properties, Signages -->
               <li class="nav-item">
                   <a href="#" class="nav-link">
                       <i class="nav-icon bi bi-collection"></i>
                       <p>
                           Client Assets
                           <i class="nav-arrow bi bi-chevron-right"></i>
                       </p>
                   </a>
                   <ul class="nav nav-treeview">
                       <li class="nav-item"><a href="/business/showBusinesses" class="nav-link">Businesses</a></li>
                       <li class="nav-item"><a href="/property/showProperties" class="nav-link">Properties</a></li>
                       <li class="nav-item"><a href="/signages" class="nav-link">Signages</a></li>
                   </ul>
               </li>
   
               <!-- Billing -->
               <li class="nav-item">
                   <a href="/billing" class="nav-link">
                       <i class="nav-icon bi bi-receipt"></i>
                       <p>Billing</p>
                   </a>
               </li>
   
               <!-- Payment -->
               <li class="nav-item">
                   <a href="/payment/showPaymentPage" class="nav-link">
                       <i class="nav-icon bi bi-credit-card"></i>
                       <p>Payment</p>
                   </a>
               </li>
   
               <!-- Approve Payment -->
               <li class="nav-item">
                 <a href="/payment/showPaymentApprovalPage" class="nav-link">
                     <i class="nav-icon bi bi-clipboard-check"></i>
                     <p>Approve Payment</p>
                 </a>
             </li>
   
             <!-- Revenue Collectors -->
             <li class="nav-item">
                 <a href="#" class="nav-link">
                     <i class="nav-icon bi bi-people-fill"></i>
                   <p> Revenue Collector
                     <i class="nav-arrow bi bi-chevron-right"></i>
                   </p>
                 </a>
                 <ul class="nav nav-treeview">
                   <li class="nav-item"><a href="/collector/" class="nav-link">Add Collector</a></li>
                   <li class="nav-item"><a href="/collector/collectorBills" class="nav-link">Manage Collector Bills</a></li>
                   <li class="nav-item"><a href="/collector/billAssignment" class="nav-link">Assign Bills</a></li>
               </ul>
             </li>
   
               <!-- Reports -->
               <li class="nav-item">
                   <a href="#" class="nav-link">
                       <i class="nav-icon bi bi-graph-up"></i>
                     <p> Reports
                       <i class="nav-arrow bi bi-chevron-right"></i>
                     </p>
                   </a>
                   <ul class="nav nav-treeview">
                     <li class="nav-item"><a href="/report/businessBillReport" class="nav-link">Business Bill</a></li>
                     <li class="nav-item"><a href="/report/propertyBillReport" class="nav-link">Property Bill</a></li>
                     <li class="nav-item"><a href="/report/CollectorBusinessBillReport" class="nav-link">Collector Business Bills</a></li>
                    <li class="nav-item"><a href="/report/CollectorPropertyBillReport" class="nav-link">Collector Property Bills</a></li>
                    <li class="nav-item"><a href="/report/CollectorBusinessSummaryReport" class="nav-link">Collector Business Summary</a></li>
                    <li class="nav-item"><a href="/report/CollectorPropertySummaryReport" class="nav-link">Collector Property Summary</a></li>
                 </ul>
               </li>
               
   
               <!-- Settings -->
               <li class="nav-item">
                   <a href="/settings" class="nav-link">
                       <i class="nav-icon bi bi-gear"></i>
                       <p>Settings</p>
                   </a>
               </li>
   
               <!-- User Management -->
               <li class="nav-item">
                   <a href="/user/user-management" class="nav-link">
                       <i class="nav-icon bi bi-person-badge"></i>
                       <p>User Management</p>
                   </a>
               </li>
           </ul>
       </nav>
   </div>
   </aside>


      <!-- Content Header -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Revenue Dashboard</h1>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="content">
        <div class="container-fluid">
          <!-- KPIs -->
          <div class="form-group">
            <label for="kpi-year">Select Year:</label>
            <select id="kpi-year" class="form-control">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <!-- Add more years as needed -->
            </select>
          </div>
          
          <div class="row">
            <div class="col-lg-3 col-6">
              <div class="small-box bg-info">
                <div class="inner">
                  <h3 id="total-bills">Loading...</h3>
                  <p>Total Bills</p>
                </div>
                <div class="icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-6">
              <div class="small-box bg-success">
                <div class="inner">
                  <h3 id="total-revenue">Loading...</h3>
                  <p>Total Bill Value (GH₵)</p>
                </div>
                <div class="icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-6">
              <div class="small-box bg-warning">
                <div class="inner">
                  <h3 id="total-collected">Loading...</h3>
                  <p>Total Revenue Collected (GH₵)</p>
                </div>
                <div class="icon">
                  <i class="fas fa-coins"></i>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-6">
              <div class="small-box bg-danger">
                <div class="inner">
                  <h3 id="total-outstanding">Loading...</h3>
                  <p>Total Revenue Outstanding (GH₵)</p>
                </div>
                <div class="icon">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
              </div>
            </div>
          </div>          

          <!-- Bill Distribution and Revenue Sources in One Card -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Bill Distribution and Revenue Sources</h3>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-lg-6">
                      <h5>Bill Distribution</h5>
                      <canvas id="billChart"></canvas>
                    </div>
                    <div class="col-lg-6">
                      <h5>Bill Value</h5>
                      <canvas id="billValueChart"></canvas>
                    </div>
                    <div class="col-lg-6">
                      <h5>Revenue Sources</h5>
                      <canvas id="revenueChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Revenue Trends and Agent Productivity Side by Side -->
          <div class="row">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Revenue Trends (Monthly)</h3>
                </div>
                <div class="card-body">
                  <canvas id="revenueTrendsChart"></canvas>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Revenue Collectors Productivity</h3>
                </div>
                <div class="card-body scrollable-table">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Collector's Name</th>
                        <th>Bills Assigned</th>
                        <th>Total Bill Value (GH₵)</th>
                        <th>Bills Served</th>
                        <th>Bills Collected</th>
                      </tr>
                    </thead>
                    <tbody id="agentsTable">
                      <tr>
                        <td>Loading...</td>
                        <td>0</td>
                        <td>0.00</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
 <!-- Required Scripts -->
 <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/browser/overlayscrollbars.browser.es6.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
 <script src="/dist/js/adminlte.js"></script>
 

  <!-- Scripts -->
  <script>
    let year = new Date().getFullYear();
        // Fetch KPIs
        fetch(`/dashboard/getKPIS?year=${year}`)
          .then(response => response.json())
          .then(data => {
            const totalRevenue = parseFloat(data.total_revenue) || 0;
            const totalCollected = parseFloat(data.total_collected) || 0;
            const totalOutstanding = parseFloat(data.total_outstanding) || 0;

            document.getElementById('total-bills').innerText = data.total_bills || 0;
            document.getElementById('total-revenue').innerText = totalRevenue.toFixed(2);
            document.getElementById('total-collected').innerText = totalCollected.toFixed(2);
            document.getElementById('total-outstanding').innerText = totalOutstanding.toFixed(2);
          })
          .catch(error => {
            console.error('Error fetching KPIs:', error);
            alert('Failed to fetch KPIs. Please try again later.');
          });

          // Fetch Bill Distribution Data
    
          fetch(`/dashboard/getBillDistribution?year=${year}`)
          .then(response => response.json())
          .then(data => {
            const billChartCtx = document.getElementById('billChart').getContext('2d');
            new Chart(billChartCtx, {
              type: 'bar',
              data: {
                labels: ['Bills Printed', 'Bills Served',],
                datasets: [
                  {
                    label: 'Bill Distribution',
                    data: [data.Printed, data.Served],
                    backgroundColor: [
                      'rgba(54, 162, 235, 0.5)', 
                      'rgba(255, 99, 132, 0.5)', 
                    ],
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Count',
                    },
                  },
                },
              },
            });
          })
          .catch(error => console.error('Error fetching Bill Distribution data:', error));

          // Fetch Bill Distribution Value
          fetch(`/dashboard/getBillDistribution?year=${year}`)
          .then(response => response.json())
          .then(data => {
            const billChartCtx = document.getElementById('billValueChart').getContext('2d');
            new Chart(billChartCtx, {
              type: 'bar',
              data: {
                labels: ['Bills Printed Value','Bills Served Value'],
                datasets: [
                  {
                    label: 'Bill Distribution',
                    data: [data.PrintedValue, data.ServedValue],
                    backgroundColor: [
                      'rgba(54, 162, 235, 0.5)', 
                      'rgba(255, 99, 132, 0.5)', 
                    ],
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Value (GH₵)',
                    },
                  },
                },
              },
            });
          })
          .catch(error => console.error('Error fetching Bill Distribution data:', error));

          // Fetch Revenue Sources Data
          fetch(`/dashboard/getRevenueSources?year=${year}`)
            .then(response => response.json())
            .then(data => {
              if (!data || data.length === 0) {
                console.error('No data received for Revenue Sources');
                return;
              }

              const labels = data.map(item => item.entity_type);
              const values = data.map(item => item.total_amount);

              const revenueChartCtx = document.getElementById('revenueChart').getContext('2d');
              new Chart(revenueChartCtx, {
                type: 'bar',
                data: {
                  labels,
                  datasets: [
                    {
                      label: 'Amount (GH₵)',
                      data: values,
                      backgroundColor: [
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                      ],
                    },
                  ],
                },
              });
            })
            .catch(error => console.error('Error fetching Revenue Sources data:', error));

        // Fetch Revenue Trends Data
        fetch(`/dashboard/getRevenueTrends?year=${year}`)
          .then(response => response.json())
          .then(data => {
            const labels = data.map(item => `Month ${item.month}`);
            const values = data.map(item => item.total_revenue);

            const ctx = document.getElementById('revenueTrendsChart').getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Monthly Revenue (GH₵)',
                  data: values,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  fill: true,
                }],
              },
            });
          });

        // Fetch Agent Productivity Data
        document.addEventListener('DOMContentLoaded', () => {
          fetch(`/dashboard/getAgentProductivity?year=${year}`)
            .then(response => response.json())
            .then(data => {
              const tableBody = document.getElementById('agentsTable');
              if (!tableBody) {
                console.error('Element with id="agentsTable" not found.');
                return;
              }
              tableBody.innerHTML = data.map(row => `
                <tr>
                  <td>${row.collector_name}</td>
                  <td>${row.bills_assigned}</td>
                  <td>${parseFloat(row.total_bill_value || 0).toFixed(2)}</td>
                  <td>${row.bills_served}</td>
                  <td>${row.bills_collected}</td>
                </tr>
              `).join('');
            })
            .catch(error => console.error('Error fetching Agent Productivity:', error));
        });


          // Event Listener for Year Selection
        // document.getElementById('kpi-year').addEventListener('change', (event) => {
        //   const selectedYear = event.target.value;
        //   fetchKPIs(selectedYear);
        // });

        // // Initial Fetch for Current Year
        // const currentYear = new Date().getFullYear();
        // document.getElementById('kpi-year').value = currentYear;
        // fetchKPIs(currentYear);

  </script>
</body>
</html>
