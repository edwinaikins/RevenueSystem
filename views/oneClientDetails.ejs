<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Revenue Management App</title>
        <!-- Primary Meta Tags -->
        <meta name="title" content="Revenue Management System">
        <meta name="author" content="Edwin Pokoo-Aikins">
        <meta name="description" content="Revenue Management System.">
       
        <!-- Fonts and Styles -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/styles/overlayscrollbars.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="/dist/css/adminlte.css">
      </head>
      
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
 <div class="app-wrapper">
    <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <!-- Sidebar Toggle -->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                <i class="bi bi-list"></i>
              </a>
            </li>
            <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Home</a></li>
            <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Contact</a></li>
          </ul>
      
          <!-- Right Navbar Links -->
          <ul class="navbar-nav ms-auto">
            <!-- Search Icon -->
            <li class="nav-item"><a class="nav-link" data-widget="navbar-search" href="#"><i class="bi bi-search"></i></a></li>
            <!-- Messages Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link" data-bs-toggle="dropdown" href="#">
                <i class="bi bi-chat-text"></i> <span class="navbar-badge badge text-bg-danger">3</span>
              </a>
              <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <!-- Message items here -->
                <a href="#" class="dropdown-item">See All Messages</a>
              </div>
            </li>
            <!-- Notifications Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link" data-bs-toggle="dropdown" href="#">
                <i class="bi bi-bell-fill"></i> <span class="navbar-badge badge text-bg-warning">15</span>
              </a>
              <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <!-- Notification items here -->
                <a href="#" class="dropdown-item">See All Notifications</a>
              </div>
            </li>
            <!-- User Profile Dropdown -->
            <!-- <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">
                <img src="/dist/assets/img/user2-160x160.jpg" class="user-image rounded-circle" alt="User Image"> <span class="d-none d-md-inline">Alexander Pierce</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <li class="user-header text-bg-primary">
                  <img src="/dist/assets/img/user2-160x160.jpg" class="rounded-circle" alt="User Image">
                  <p>Alexander Pierce - Web Developer</p>
                </li>
                <li class="user-footer">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                  <a href="#" class="btn btn-default btn-flat float-end">Sign out</a>
                </li>
              </ul>
            </li> -->
          </ul>
        </div>
      </nav>
      
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <!-- Sidebar Brand -->
        <div class="sidebar-brand">
            <a href="/" class="brand-link">
                <img src="/dist/assets/img/AdminLTELogo.png" alt="NAMA Logo" class="brand-image opacity-75 shadow">
                <span class="brand-text fw-light">RMS</span>
            </a>
        </div>
      
        <!-- Sidebar Menu -->
        <div class="sidebar-wrapper">
            <nav class="mt-2">
                <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
                    <!-- Dashboard -->
                    <li class="nav-item">
                        <a href="/user/dashboard" class="nav-link active">
                            <i class="nav-icon bi bi-speedometer"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
      
                    <!-- Clients -->
                    <li class="nav-item">
                        <a href="/client/getall" class="nav-link">
                            <i class="nav-icon bi bi-people"></i>
                            <p>Clients</p>
                        </a>
                    </li>
      
                    <!-- Grouped: Businesses, Properties, Signages -->
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="nav-icon bi bi-collection"></i>
                            <p>
                                Client Assets
                                <i class="nav-arrow bi bi-chevron-right"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item"><a href="/businesses" class="nav-link">Businesses</a></li>
                            <li class="nav-item"><a href="/properties" class="nav-link">Properties</a></li>
                            <li class="nav-item"><a href="/signages" class="nav-link">Signages</a></li>
                        </ul>
                    </li>
      
                    <!-- Billing -->
                    <li class="nav-item">
                        <a href="/billing" class="nav-link">
                            <i class="nav-icon bi bi-receipt"></i>
                            <p>Billing</p>
                        </a>
                    </li>
      
                    <!-- Payment -->
                    <li class="nav-item">
                        <a href="/payment" class="nav-link">
                            <i class="nav-icon bi bi-credit-card"></i>
                            <p>Payment</p>
                        </a>
                    </li>
      
                    <!-- Reports -->
                    <li class="nav-item">
                        <a href="/reports" class="nav-link">
                            <i class="nav-icon bi bi-graph-up"></i>
                            <p>Reports</p>
                        </a>
                    </li>
      
                    <!-- Settings -->
                    <li class="nav-item">
                        <a href="/settings" class="nav-link">
                            <i class="nav-icon bi bi-gear"></i>
                            <p>Settings</p>
                        </a>
                    </li>
      
                    <!-- User Management -->
                    <li class="nav-item">
                        <a href="/user/user-management" class="nav-link">
                            <i class="nav-icon bi bi-person-badge"></i>
                            <p>User Management</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
      </aside>      
      


   <!-- Main Content Area -->
   <!-- <main class="app-main">
     <div class="app-content-header">
       <div class="container-fluid">
         <div class="row">
           <div class="col-sm-6">
             <h3 class="mb-0"><%= pageTitle %></h3>
           </div>
           <div class="col-sm-6">
             <ol class="breadcrumb float-sm-end">
               <li class="breadcrumb-item"><a href="#">Home</a></li>
               <li class="breadcrumb-item active"><%= pageTitle %></li>
             </ol>
           </div>
         </div>
       </div>
     </div> -->
     <div class="app-content">
       <div class="container-fluid">
         <!-- Yield content here -->
         <body>
            <div class="container mt-5">
                <h2 class="mb-4 text-center">Client Dashboard</h2>
                
                <!-- Client Information Card -->
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h5 class="card-title">Client Details</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Client ID:</strong> <%= client.client_id %></p>
                        <p><strong>Client Name:</strong> <%= client.firstname %> <%= client.lastname %> </p>
                        <p><strong>Contact:</strong> <%= client.contact %></p>
                        <p><strong>Email:</strong> <%= client.email %></p>
                    </div>
                </div>
            
                <!-- Tabs for Registrations -->
                <ul class="nav nav-tabs mt-4" id="registrationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="business-tab" data-bs-toggle="tab" data-bs-target="#business" type="button" role="tab" aria-controls="business" aria-selected="true">Businesses</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="property-tab" data-bs-toggle="tab" data-bs-target="#property" type="button" role="tab" aria-controls="property" aria-selected="false">Properties</button>
                    </li>
                </ul>
            
                <!-- Tab Content -->
                <div class="tab-content mt-3" id="registrationTabsContent">
                    <!-- Businesses -->
                    <div class="tab-pane fade show active" id="business" role="tabpanel" aria-labelledby="business-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Registered Businesses</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#businessRegistrationModal">
                                <i class="fas fa-plus"></i> Add Business
                            </button>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Business Name</th>
                                    <th>Contact</th>
                                    <th>Activity</th>
                                    <th>Structure</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Address</th>
                                    <th>Location</th>
                                    <th>GPA</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% businesses.forEach((business, index) => { %>
                                    <tr data-id="<%= business.id %>" data-business-type-id="<%= business.entity_type_id %>"
                                        data-location-id="<%= business.location_id %>">
                                        <td><%= index + 1 %></td>
                                        <td><%= business.business_name %></td>
                                        <td><%= business.business_contact %></td>
                                        <td><%= business.business_activity %></td>
                                        <td><%= business.business_structure %></td>
                                        <td><%= business.business_size %></td>
                                        <td><%= business.division %></td>
                                        <td><%= business.address %></td>
                                        <td><%= business.location %></td>
                                        <td><%= business.digital_address %></td>
                                        <td>
                                            <button class="btn btn-sm btn-info">Edit</button>
                                            <button class="btn btn-sm btn-danger">Delete</button>
                                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='/business/businessFee/<%= client.client_id %>';">Fee Fixing</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
            
                    <!-- Properties -->
                    <div class="tab-pane fade" id="property" role="tabpanel" aria-labelledby="property-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Registered Properties</h5>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#propertyRegistrationModal">
                                <i class="fas fa-plus"></i> Add Property
                            </button>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>House Number</th>
                                    <th>Digital Address</th>
                                    <th>Location</th>
                                    <th>Property Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% properties.forEach((property, index) => { %>
                                    <tr data-id="<%= property.id %>" data-property-type-id="<%= property.entity_type_id %>"
                                        data-location-id="<%= property.location_id %>">
                                        <td><%= index + 1 %></td>
                                        <td><%= property.house_number %></td>
                                        <td><%= property.digital_address %></td>
                                        <td><%= property.location %></td>
                                        <td><%= property.division %></td>
                                        <td>
                                            <button class="btn btn-sm btn-info">Edit</button>
                                            <button class="btn btn-sm btn-danger">Delete</button>
                                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='/property/propertyFee/<%= client.client_id %>';">Fee Fixing</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
         </body>
       </div>
     </div>
   </main>


   <footer class="app-footer">
    <div class="float-end d-none d-sm-inline"></div>
    <strong>&copy; 2024 <a href="nama.gov.gh">Nsawam-Adoagyiri Municipal Assembly</a>. All rights reserved.</strong>
  </footer>
  
 </div>

<!-- Business Registration Modal -->
<div class="modal fade" id="businessRegistrationModal" tabindex="-1" aria-labelledby="businessRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Adjusted modal size for better spacing -->
        <div class="modal-content">
            <form id="businessRegistrationForm" method="POST" action="/register/business">
                <div class="modal-header">
                    <h5 class="modal-title" id="businessRegistrationModalLabel">Business Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row mb-3">
                            <!-- Client ID (Pre-populated, Read-only) -->
                            <div class="col-md-6">
                                <label for="clientId" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="clientId" name="client_id" value= "<%= client.client_id %>" readonly>
                            </div>
                        </div>
 
 
                        <div class="row mb-3">
                            <!-- Business Name -->
                            <div class="col-md-6">
                                <label for="businessName" class="form-label">Business Name</label>
                                <input type="text" class="form-control" id="businessName" name="business_name" required>
                            </div>
                            <!-- Business Contact -->
                            <div class="col-md-6">
                                <label for="businessContact" class="form-label">Business Contact</label>
                                <input type="tel" class="form-control" id="businessContact" name="business_contact" pattern="^(\+?\d{1,4}[-.\s]?|)\(?\d{1,3}?\)?[-.\s]?\d{1,4}[-.\s]?\d{1,4}[-.\s]?\d{1,9}$" required>
                                <small class="form-text text-muted">Enter a valid phone number</small>
                            </div>
                        </div>
 
 
                        <div class="row mb-3">
                            <!-- Business Activity -->
                            <div class="col-md-12">
                                <label for="businessActivity" class="form-label">Business Activity</label>
                                <textarea class="form-control" id="businessActivity" name="business_activity" rows="4" placeholder="Describe your business activity" required></textarea>
                            </div>
                        </div>
 
 
                        <div class="row mb-3">
                            <!-- Business Structure -->
                            <div class="col-md-6">
                                <label for="businessStructure" class="form-label">Business Structure</label>
                                <select class="form-control" id="businessStructure" name="business_structure" required>
                                    <option value="" disabled selected>Select Business Structure</option>
                                    <option value="Block Building">Block Building</option>
                                    <option value="Container">Container</option>
                                    <option value="Wooden Structure">Wooden Structure</option>
                                </select>
                            </div>
 
 
                            <!-- Business Size -->
                            <div class="col-md-6">
                                <label for="businessSize" class="form-label">Business Size</label>
                                <select class="form-control" id="businessSize" name="business_size" required>
                                    <option value="" disabled selected>Select Business Size</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Large">Large</option>
                                </select>
                            </div>
                        </div>
 
 
                        <div class="row mb-3">
                            <!-- Business Type ID -->
                            <div class="col-md-6">
                                <label for="entityTypeId" class="form-label">Business Type</label>
                                <select class="form-control" id="entityTypeId" name="entity_type_id" required>
                                    <option value="" disabled selected>Select a Business Type</option>
                                    <% entity_type.forEach(type => { %>
                                        <option value="<%= type.entity_type_id %>"><%= type.division %></option>
                                    <% }) %>
                                </select>
                            </div>
 
 
                            <!-- Address -->
                            <div class="col-md-6">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" name="address" required>
                            </div>
                        </div>
 
 
                        <div class="row mb-3">
                            <!-- Location ID -->
                            <div class="col-md-6">
                                <label for="locationId" class="form-label">Location</label>
                                <select class="form-control" id="locationId" name="location_id" required>
                                    <option value="" disabled selected>Select a Location</option>
                                    <% locations.forEach(loc => { %>
                                        <option value="<%= loc.location_id %>"><%= loc.location %></option>
                                    <% }) %>
                                </select>
                            </div>
 
 
 
 
                            <!-- Digital Address -->
                            <div class="col-md-6">
                                <label for="digitalAddress" class="form-label">Digital Address</label>
                                <input type="text" class="form-control" id="digitalAddress" name="digital_address" required>
                            </div>
                        </div>
                    </div>
                </div>
 
 
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Register Business</button>
                </div>
            </form>
        </div>
    </div>
 </div>
 <!-- Property Registration Modal -->
<div class="modal fade" id="propertyRegistrationModal" tabindex="-1" aria-labelledby="propertyRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="propertyRegistrationForm" method="POST" action="/register/property">
                <div class="modal-header">
                    <h5 class="modal-title" id="propertyRegistrationModalLabel">Property Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row mb-3">
                            <!-- Client ID (Pre-populated, Read-only) -->
                            <div class="col-md-6">
                                <label for="clientId" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="clientId" name="client_id" value= "<%= client.client_id %>" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <!-- House Number -->
                            <div class="col-md-6">
                                <label for="houseNumber" class="form-label">House Number</label>
                                <input type="text" class="form-control" id="houseNumber" name="house_number" required>
                            </div>

                            <!-- Digital Address -->
                            <div class="col-md-6">
                                <label for="digitalAddress" class="form-label">Digital Address</label>
                                <input type="text" class="form-control" id="propertyDigitalAddress" name="digital_address" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <!-- Location -->
                            <div class="col-md-6">
                                <label for="locationId" class="form-label">Location</label>
                                <select class="form-control" id="propertyLocationId" name="location_id" required>
                                    <option value="" disabled selected>Select a Location</option>
                                    <% locations.forEach(location => { %>
                                        <option value="<%= location.location_id %>"><%= location.location %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <!-- Property Description -->
                            <div class="col-md-6">
                                <label for="property_type_id" class="form-label">Property Type</label>
                                <select class="form-control" id="entity_type_id" name="entity_type_id" required>
                                    <option value="" disabled selected>Select Property Type</option>
                                    <% entity_type.forEach(type => { %>
                                        <option value="<%= type.entity_type_id %>"><%= type.division %></option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Register Property</button>
                </div>
            </form>
        </div>
    </div>
</div>


 <!-- Required Scripts -->
<script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/browser/overlayscrollbars.browser.es6.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
<script src="/dist/js/adminlte.js"></script>

<!-- Custom Scripts -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const businessTable = document.querySelector("#business tbody");
        const registrationModal = new bootstrap.Modal(document.getElementById("businessRegistrationModal"));
        const form = document.getElementById("businessRegistrationForm");
        const submitButton = form.querySelector("button[type='submit']");

        // Handle Delete Action (unchanged)
        businessTable.addEventListener("click", async (event) => {
            if (event.target.classList.contains("btn-danger")) {
                const row = event.target.closest("tr");
                const businessId = row.getAttribute("data-id");

                if (!businessId) {
                    alert("Invalid business ID. Please try again.");
                    return;
                }

                if (confirm("Are you sure you want to delete this business?")) {
                    try {
                        const response = await fetch(`/business/delete/${businessId}`, { method: "DELETE" });

                        if (response.ok) {
                            row.remove(); // Remove the row from the table
                            alert("Business deleted successfully!");
                            window.location.reload()
                        } else {
                            alert("Failed to delete business. Please try again.");
                        }
                    } catch (error) {
                        console.error("Error deleting business:", error);
                        alert("An unexpected error occurred.");
                    }
                }
            }
        });

        // Handle Edit Button Click (updated to read from table row)
        businessTable.addEventListener("click", (event) => {
            if (event.target.classList.contains("btn-info")) {
                const row = event.target.closest("tr");

                // Populate the modal form with data from the table row
                document.getElementById("businessName").value = row.children[1].textContent.trim();
                document.getElementById("businessContact").value = row.children[2].textContent.trim();
                document.getElementById("businessStructure").value = row.children[4].textContent.trim();
                document.getElementById("businessSize").value = row.children[5].textContent.trim();
                document.getElementById("businessActivity").value = row.children[3].textContent.trim();
                document.getElementById("address").value = row.children[7].textContent.trim();
                document.getElementById("digitalAddress").value = row.children[9].textContent.trim();
                document.getElementById("entityTypeId").value = row.getAttribute("data-business-type-id") || "";
                document.getElementById("locationId").value = row.getAttribute("data-location-id") || "";
        
                // Add the business ID to the form for editing
                form.dataset.id = row.getAttribute("data-id");

                // Change the submit button text to "Save"
                submitButton.textContent = "Save";

                // Show the modal
                registrationModal.show();
            }
        });

        // Handle Form Submission for Edit and Add (unchanged)
        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const businessId = this.dataset.id || null; // Determine if it's an edit or new entry
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const url = businessId ? `/business/update/${businessId}` : "/business/register";
                const method = businessId ? "PUT" : "POST";

                const response = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const updatedBusiness = await response.json();

                    if (businessId) {
                        // Update the corresponding row in the table
                        const row = document.querySelector(`tr[data-id='${businessId}']`);
                        row.children[1].textContent = updatedBusiness.business_name;
                        row.children[2].textContent = updatedBusiness.business_contact;
                        row.children[4].textContent = updatedBusiness.business_structure;
                        row.children[5].textContent = updatedBusiness.business_size;
                        row.children[8].textContent = updatedBusiness.location;
                        row.children[3].textContent = updatedBusiness.business_activity;
                        row.children[6].textContent = updatedBusiness.division;
                        row.children[7].textContent = updatedBusiness.address;
                        row.children[9].textContent = updatedBusiness.digital_address;

                    } else {
                        // Add new row for a new business
                        const newRow = `
                            <tr data-id="${updatedBusiness.id}">
                                <td>${businessTable.children.length + 1}</td>
                                <td>${updatedBusiness.business_name}</td>
                                <td>${updatedBusiness.business_contact}</td>
                                <td>${updatedBusiness.business_activity}</td>
                                <td>${updatedBusiness.business_structure}</td>
                                <td>${updatedBusiness.location}</td>
                                <td>${updatedBusiness.division}</td>
                                <td>${updatedBusiness.address}</td>
                                <td>${updatedBusiness.location}</td>
                                <td>${updatedBusiness.digital_address}</td>
                                <td>
                                    <button class="btn btn-sm btn-info">Edit</button>
                                    <button class="btn btn-sm btn-danger">Delete</button>
                                </td>
                            </tr>`;
                        businessTable.insertAdjacentHTML("beforeend", newRow);
                    }

                    // Reset form and hide modal
                    this.reset();
                    delete this.dataset.id; // Remove data-id for new entries
                    registrationModal.hide();

                    alert("Business saved successfully!");
                    window.location.reload()
                } else {
                    alert("Failed to save business. Please try again.");
                }
            } catch (error) {
                console.error("Error saving business:", error);
                alert("An unexpected error occurred.");
            }
        });

        // Reset Modal on Close (unchanged)
        document.getElementById("businessRegistrationModal").addEventListener("hidden.bs.modal", function () {
            form.reset();
            delete form.dataset.id; // Clear data-id for new entries
            submitButton.textContent = "Register"; // Reset button text
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const propertyTable = document.querySelector("#property tbody");
        const propertyModal = new bootstrap.Modal(document.getElementById("propertyRegistrationModal"));
        const propertyForm = document.getElementById("propertyRegistrationForm");
        const propertySubmitButton = propertyForm.querySelector("button[type='submit']");

        // Handle Delete Action for Properties
        propertyTable.addEventListener("click", async (event) => {
            if (event.target.classList.contains("btn-danger")) {
                const row = event.target.closest("tr");
                const propertyId = row.getAttribute("data-id");
    
                if (!propertyId) {
                    alert("Invalid property ID. Please try again.");
                    return;
                }

                if (confirm("Are you sure you want to delete this property?")) {
                    try {
                        const response = await fetch(`/property/delete/${propertyId}`, { method: "DELETE" });

                        if (response.ok) {
                            row.remove(); // Remove the row from the table
                            alert("Property deleted successfully!");
                            window.location.reload()
                        } else {
                            alert("Failed to delete property. Please try again.");
                        }
                    } catch (error) {
                        console.error("Error deleting property:", error);
                        alert("An unexpected error occurred.");
                    }
                }
            }
        });

        // Handle Edit Button Click for Properties
        propertyTable.addEventListener("click", (event) => {
            if (event.target.classList.contains("btn-info")) {
                const row = event.target.closest("tr");

                // Populate the modal form with data from the table row
                document.getElementById("houseNumber").value = row.children[1]?.textContent.trim();
                document.getElementById("propertyDigitalAddress").value = row.children[2]?.textContent.trim();
                document.getElementById("propertyLocationId").value = row.getAttribute("data-location-id") || "";
                document.getElementById("entity_type_id").value = row.getAttribute("data-property-type-id") || "";
                console.log(document.getElementById("entity_type_id").value)
                console.log(document.getElementById("propertyLocationId").value )

                // Add the property ID to the form for editing
                propertyForm.dataset.id = row.getAttribute("data-id");

                // Change the submit button text to "Save"
                propertySubmitButton.textContent = "Save";

                // Show the modal
                propertyModal.show();
            }
        });

        // Handle Form Submission for Properties
        propertyForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const propertyId = this.dataset.id || null; // Determine if it's an edit or new entry
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const url = propertyId ? `/property/update/${propertyId}` : "/property/register";
                const method = propertyId ? "PUT" : "POST";

                const response = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const updatedProperty = await response.json();

                    if (propertyId) {
                        // Update the corresponding row in the table
                        const row = document.querySelector(`tr[data-id='${propertyId}']`);
                        row.children[1].textContent = updatedProperty.house_number;
                        row.children[2].textContent = updatedProperty.digital_address;
                        row.children[3].textContent = updatedProperty.location;
                        row.children[4].textContent = updatedProperty.division;
                    } else {
                        // Add new row for a new property
                        const newRow = `
                            <tr data-id="${updatedProperty.id}">
                                <td>${propertyTable.children.length + 1}</td>
                                <td>${updatedProperty.house_number}</td>
                                <td>${updatedProperty.digital_address}</td>
                                <td>${updatedProperty.location}</td>
                                <td>${updatedProperty.division}</td>
                                <td>
                                    <button class="btn btn-sm btn-info">Edit</button>
                                    <button class="btn btn-sm btn-danger">Delete</button>
                                </td>
                            </tr>`;
                        propertyTable.insertAdjacentHTML("beforeend", newRow);
                    }

                    // Reset form and hide modal
                    this.reset();
                    delete this.dataset.id; // Remove data-id for new entries
                    propertyModal.hide();

                    alert("Property saved successfully!");
                    window.location.reload()
                } else {
                    alert("Failed to save property. Please try again.");
                }
            } catch (error) {
                console.error("Error saving property:", error);
                alert("An unexpected error occurred.");
            }
        });

        // Reset Modal on Close for Properties
        document.getElementById("propertyRegistrationModal").addEventListener("hidden.bs.modal", function () {
            propertyForm.reset();
            delete propertyForm.dataset.id; // Clear data-id for new entries
            propertySubmitButton.textContent = "Add Property"; // Reset button text
        });
    });
</script>


 
</body>
</html>